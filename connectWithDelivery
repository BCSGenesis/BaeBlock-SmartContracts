// SPDX-License-Identifier: MIT
pragma solidity ^0.8.18;

contract Payment {
    
    address public owner;
    //ğŸš©í”Œë«í¼ ì£¼ì¸ì„¤ì •
    constructor(){
        owner=msg.sender;
    }

    //ê³ ê° êµ¬ì¡°ì²´
    struct Customer {
        address customerWallet;
        string customerAddress; //ğŸš©ë°°ë‹¬ë°›ì„ ì£¼ì†Œ
        Basket basket; //ğŸš©ê°œì¸ ì¥ë°”êµ¬ë‹ˆ ë‚´ì—­
        Order goingOrder; //ğŸš©ì§„í–‰ì¤‘ì¸ ì£¼ë¬¸ë‚´ì—­?
        mapping(uint=>Order) pastOrderList;
    }
    
    //ê°€ê²Œ ì ì£¼ ì…ì¥ êµ¬ì¡°ì²´
    struct Store_own {
        address storeWallet;
        string storeName;
        string storeAddress;
        mapping(string=>Menu)menuList;
        mapping(uint=>Order)orderList; //ğŸš©ì£¼ë¬¸ë“¤ì–´ì˜¨ ë‚´ì—­? í˜„ì¬, ê³¼ê±° ë‚´ì—­ ëª¨ë‘ ë³´ì´ë‚˜ìš”?
    }

    //ê°€ê²Œ ê³ ê° ì…ì¥ êµ¬ì¡°ì²´  //ğŸš©ê°€ê²Œ ì ì£¼ ì…ì¥ êµ¬ì¡°ì²´ë‘ inputê°’ì´ ë™ì¼í•œê°€ìš”?
    struct Store_cus {
        address storeWallet;
        string storeName;
        string storeAddress;
        mapping(string=>Menu) menuList;
    }
    
    //ë°°ë‹¬ì› êµ¬ì¡°ì²´
    struct Rider {
        address riderWallet;
        mapping(uint=>Order) orders; //ğŸš©uintê°’ìœ¼ë¡œ orderIDê°€ ë“¤ì–´ê°€ëŠ”ê±° ë§ë‚˜ìš”?
    }
    
    //ë©”ë‰´ êµ¬ì¡°ì²´ 
    struct Menu {
        string name;
        uint price;
        uint count;  
    }
    
    //ì¥ë°”êµ¬ë‹ˆ êµ¬ì¡°ì²´
    struct Basket {
        address customerAddr;
        address storeAddr;
        string customerAddress;
        string storeAddress;
        Menu[] menuNames;
        uint foodPrice;
        uint deliveryFee;
    }
    //ì£¼ë¬¸ êµ¬ì¡°ì²´
    struct Order {
        uint orderID;
        address customerAddr;
        address storeAddr;
        address riderAddr;
        string customerAddress;
        string storeAddress;
        mapping(string=>Menu) menuName;
        uint foodPrice;
        uint deliveryFee;
        uint deliveryTip;
        storeState storeStatus;
        riderState riderStatus;
    }
    //ì£¼ë¬¸ì— ëŒ€í•œ ê°€ê²Œ ë°˜ì‘ ìƒíƒœ
    enum storeState {decline, accept,cookFinish, isPicked,notyetChoice,checkMoney}//ğŸš©isPicked : ëŒ€ë‹¬ì›ì´ ê°€ì§€ê³ ê°„ìƒíƒœ?..?, notyetChoice:ì‘ë‹µëŒ€ê¸°ì¤‘, checkMoney : ë°°ë‹¬ë¹„ ì§€ë¶ˆí•¨?, ê³ ê°ì´ë³´ë‚¸ëˆ ë°›ìŒ?
    //ì£¼ë¬¸ì— ëŒ€í•œ ë°°ë‹¬ì› ë°˜ì‘ ìƒíƒœ
    enum riderState {notSelected, inDelivery, isPicked, deliveryComplete,checkMoney} //ğŸš© isPicked,checkMoney

    //ê³ ê°ë“¤ ì €ì¥ëœ ë§µí•‘
    mapping(address => Customer) customers;
    //ê°€ê²Œë“¤ ì €ì¥ëœ ë°°ì—´(ê³ ê°ì´ ì‡¼í•‘í•˜ëŠ” ì…ì¥)
    Store_cus[] stores_customer;
    //ê°€ê²Œë“¤ ì €ì¥ëœ ë°°ì—´(ê°€ê²Œì£¼ì¸ ê´€ë¦¬í•˜ëŠ” ì…ì¥)
    mapping(address=>Store_own) stores_owner;
    //ë°°ë‹¬ì›ë“¤ ì €ì¥ëœ ë§µí•‘
    mapping(address => Rider) riders;
    //ë°°ë‹¬ëŒ€ê¸°ëª©ë¡
    Order[] deliveryWaitingList;

    //ì£¼ë¬¸ê³ ìœ ë²ˆí˜¸ ğŸš©orderIDë‘ì€ ë‹¤ë¥¸ê±´ê°€ìš”?
    uint public orderNum;

    //ê°€ê²Œ------------------------------------------------------------------------------------------------

    //ê°€ê²Œ ë“±ë¡ ê¸°ëŠ¥
    function storeRegist(string memory _storeName,string memory _storeAddress) public {
        //stores_customer ë°°ì—´ì— ê°€ê²Œ ì¶”ê°€í•˜ê¸°
        Store_cus storage newStore_cus = stores_customer.push();
        newStore_cus.storeWallet=msg.sender;
        newStore_cus.storeName=_storeName;
        newStore_cus.storeAddress=_storeAddress;

        //stores_owner ë§µí•‘ì— ê°€ê²Œ ì¶”ê°€í•˜ê¸°
        Store_own storage newStore_own=stores_owner[msg.sender];
        newStore_own.storeWallet= msg.sender;
        newStore_own.storeName=_storeName;
        newStore_own.storeAddress=_storeAddress;

    }
    /*
    function get1(uint _n)public view returns(string memory){
        return stores_customer[_n].storeName;
    }
    function get2(address _a)public view returns(string memory){
        return stores_owner[_a].storeName;
    }
    */


    //ê°€ê²Œ ë©”ë‰´ ë“±ë¡ ê¸°ëŠ¥
    function storeMenuRegist(string memory _menuName,uint _price)public{
        //stores_customer ë°°ì—´ì˜ Menu[]ì— ë©”ë‰´ ì¶”ê°€í•˜ê¸°
        for(uint i=0;i<stores_customer.length;i++){
            if(stores_customer[i].storeWallet==msg.sender){
                stores_customer[i].menuList[_menuName]=Menu(_menuName,_price,0);
            }
        }
        //stores_owner ë§¤í•‘ì˜ Menu[]ì— ë©”ë‰´ ì¶”ê°€í•˜ê¸°
        stores_owner[msg.sender].menuList[_menuName]=Menu(_menuName,_price,0);
    }
    /*
    function get3(uint _n,string memory _menuName)public view returns(Menu memory){
        return stores_customer[_n].menuList[_menuName];
    }
    function get4(address _a,string memory _menuName)public view returns(Menu memory){
        return stores_owner[_a].menuList[_menuName];
    }
    */

    //ê°€ê²Œì˜ ì£¼ë¬¸ ìˆ˜ë½
    function storeAccept(uint _orderId) public {
        //ê³ ê°ì˜ orderìƒíƒœ ë³€ê²½
        customers[stores_owner[msg.sender].orderList[_orderId].customerAddr].goingOrder.storeStatus=storeState.accept;
        //ê°€ê²Œ(stores_owner)ì˜ orderìƒíƒœ ë³€ê²½
        stores_owner[msg.sender].orderList[_orderId].storeStatus=storeState.accept;
    }

    //ê°€ê²Œì˜ ì£¼ë¬¸ ê±°ì ˆ
    function storeDecline(uint _orderId) public {
        //ê³ ê°ì˜ orderìƒíƒœ ë³€ê²½
        customers[stores_owner[msg.sender].orderList[_orderId].customerAddr].goingOrder.storeStatus=storeState.decline;

        //ê°€ê²Œ(stores_owner)ì˜ orderìƒíƒœ ë³€ê²½
        stores_owner[msg.sender].orderList[_orderId].storeStatus=storeState.decline;

        //ë°°ë‹¬ëŒ€ê¸°ë¦¬ìŠ¤íŠ¸ì—ì„œ ì£¼ë¬¸ê±´ ì‚­ì œ
        for(uint i=0;i<deliveryWaitingList.length;i++){
            if(deliveryWaitingList[i].orderID==_orderId){
                delete deliveryWaitingList[i];
            }
        }
        //ê°€ê²Œ ë§¤í•‘ì—ì„œ ì§€ìš°ê¸°
        delete stores_owner[msg.sender].orderList[_orderId];
        
    }

    //ê°€ê²Œì˜ ìš”ë¦¬ ì™„ë£Œ
    function cookFinish(uint _orderId)public {
        //ê°€ê²Œ(stores_owner)ì˜ orderìƒíƒœ ë³€ê²½
        customers[stores_owner[msg.sender].orderList[_orderId].customerAddr].goingOrder.storeStatus=storeState.cookFinish;

        //ê³ ê°ì˜ orderìƒíƒœ ë³€ê²½
        stores_owner[msg.sender].orderList[_orderId].storeStatus=storeState.cookFinish;

    }
    //ğŸš© ì½ë‹¤ë³´ë‹ˆê¹Œ ê°€ê²Œì™€ ê³ ê°ì˜ orderìƒíƒœê°€ ë™ì¼í•˜ê²Œ ë³€ê²½ë˜ëŠ”ë° ë‘ê°œë¡œ ë‚˜ëˆ ì•¼í•˜ëŠ” ì´ìœ ê°€ ìˆëŠ”ì§€.. ê¶ê¸ˆí•´ì¡ŒìŠµë‹ˆë‹¹


    //ê³ ê°--------------------------------------------------------------------------------------------



    //ê³ ê° ë“±ë¡ ê¸°ëŠ¥
    function customerRegist(string memory _customerAddress) public {
        Customer storage newCustomer=customers[msg.sender];
        newCustomer.customerWallet=msg.sender;
        newCustomer.customerAddress=_customerAddress;

    }
    /*
    function getCustomer(address _a)public view returns (string memory){
        return customers[_a].customerAddress;
    }
    */

    //ì¥ë°”êµ¬ë‹ˆì— ë©”ë‰´ ë‹´ê¸°
    function addMenuToBusket(address _storeAddr,string memory _foodName,uint _count)public {
        //ğŸš©ì¥ë°”êµ¬ë‹ˆ ì£¼ì¸ì„¤ì •
        customers[msg.sender].basket.customerAddr=msg.sender;
        customers[msg.sender].basket.storeAddr=_storeAddr;
        customers[msg.sender].basket.customerAddress=customers[msg.sender].customerAddress;
        //ğŸš©....ê°€ê²Œë³„ ë©”ë‰´ë‹´ì€ê±´ê°€ìš”...? ì´í•´ë¥¼ ëª»í–ˆìŠµë‹ˆë‹¤...
        for(uint i=0;i<stores_customer.length;i++){
            if(stores_customer[i].storeWallet == _storeAddr){
                customers[msg.sender].basket.storeAddress = stores_customer[i].storeAddress;
                customers[msg.sender].basket.menuNames.push(Menu(stores_customer[i].menuList[_foodName].name,stores_customer[i].menuList[_foodName].price,_count));
            }
        }       
        customers[msg.sender].basket.foodPrice=menuTotalPriceForBasket();
        customers[msg.sender].basket.deliveryFee=0;
    }

    //ë©”ë‰´ ì´ ê°€ê²© ê³„ì‚°í•˜ê¸°
    function menuTotalPriceForBasket()public view returns(uint){
        uint totalPrice;
        uint menuLength = customers[msg.sender].basket.menuNames.length;
        for (uint i = 0; i < menuLength; i++) {
            totalPrice += customers[msg.sender].basket.menuNames[i].price*customers[msg.sender].basket.menuNames[i].count;
        }
        return totalPrice; 
    }

    // function getBasketMenu(uint _n)public view returns(Menu memory){
    //     return customers[msg.sender].basket.menuNames[_n];
    // }

    //ì£¼ë¬¸í•˜ê¸°
    function ordering(uint _deliveryTip) public {
        
        //ê³ ê°ì •ë³´ì— ì£¼ë¬¸ ì¶”ê°€ //ğŸš©new orderì— ê³ ê°ì •ë³´ ì¶”ê°€
        orderNum++;
        Order storage newOrder = customers[msg.sender].goingOrder;
        newOrder.orderID= orderNum;
        newOrder.customerAddr=msg.sender;
        newOrder.storeAddr=customers[msg.sender].basket.storeAddr;
        newOrder.customerAddress=customers[msg.sender].basket.customerAddress;
        newOrder.storeAddress=customers[msg.sender].basket.storeAddress;
        for(uint i=0;i<customers[msg.sender].basket.menuNames.length;i++){
            newOrder.menuName[customers[msg.sender].basket.menuNames[i].name]=customers[msg.sender].basket.menuNames[i];
        }
        newOrder.foodPrice=menuTotalPriceForBasket();
        newOrder.deliveryFee=0;
        newOrder.deliveryTip=_deliveryTip;
        newOrder.storeStatus=storeState.notyetChoice;
        newOrder.riderStatus=riderState.notSelected; 
        
        //ê°€ê²Œ(ê°€ê²Œë§µí•‘)ì— ì£¼ë¬¸ ì¶”ê°€  //ğŸš©ìœ„ë‘ ëª¨ë‘ ë™ì¼í•œ input??
        Order storage newOrder2 = stores_owner[customers[msg.sender].basket.storeAddr].orderList[newOrder.orderID];
        newOrder2.orderID= orderNum;
        newOrder2.customerAddr=msg.sender;
        newOrder2.storeAddr=customers[msg.sender].basket.storeAddr;
        newOrder2.customerAddress=customers[msg.sender].basket.customerAddress;
        newOrder2.storeAddress=customers[msg.sender].basket.storeAddress;
        for(uint i=0;i<customers[msg.sender].basket.menuNames.length;i++){
            newOrder2.menuName[customers[msg.sender].basket.menuNames[i].name]=customers[msg.sender].basket.menuNames[i];
        }
        newOrder2.foodPrice=menuTotalPriceForBasket();
        newOrder2.deliveryFee=0;
        newOrder2.deliveryTip=_deliveryTip;
        newOrder2.storeStatus=storeState.notyetChoice;
        newOrder2.riderStatus=riderState.notSelected;
        
        //ë°°ë‹¬ ëª©ë¡ì— ë“±ë¡ //ğŸš©ë™ì¼í•œ input? í•˜ë‚˜ë¡œ í†µí•©í•˜ë©´ ì•ˆë˜ëŠ” ì´ìœ ê°€ ìˆì„ê¹Œìš”?
        Order storage newOrder3 = deliveryWaitingList.push();
        newOrder3.orderID= orderNum;
        newOrder3.customerAddr=msg.sender;
        newOrder3.storeAddr=customers[msg.sender].basket.storeAddr;
        newOrder3.customerAddress=customers[msg.sender].basket.customerAddress;
        newOrder3.storeAddress=customers[msg.sender].basket.storeAddress;
        for(uint i=0;i<customers[msg.sender].basket.menuNames.length;i++){
            newOrder.menuName[customers[msg.sender].basket.menuNames[i].name]=customers[msg.sender].basket.menuNames[i];
        }
        newOrder3.foodPrice=menuTotalPriceForBasket();
        newOrder3.deliveryFee=0;
        newOrder3.deliveryTip=_deliveryTip;
        newOrder3.storeStatus=storeState.notyetChoice;
        newOrder3.riderStatus=riderState.notSelected; 
    }


    // function getdelivery(uint _n)public view returns(uint,address){
    //     return (deliveryWaitingList[_n].orderID,deliveryWaitingList[_n].riderAddr);
    // }
    // function getOrderingCusOrder()public view returns (uint,uint ){
    //     return (customers[msg.sender].goingOrder.orderID,customers[msg.sender].goingOrder.foodPrice);
    // }
    // function getOrderingStoreOrder(uint _n)public view returns (uint,uint ){
    //     return (stores_owner[msg.sender].orderList[_n].orderID,stores_owner[msg.sender].orderList[_n].foodPrice);
    // }
    // function getOrderingDelOrder(uint _n)public view returns (uint,uint ){
    //     return (deliveryWaitingList[_n].orderID,deliveryWaitingList[_n].foodPrice);
    // }
    
//ğŸš©ê³ ê°ì´ ì£¼ë¬¸ì„í•˜ê³  -> ê°€ê²Œìˆ˜ë½ -> ë¼ì´ë” ìˆ˜ë½ -> ê³ ê° ëˆ ì§€ë¶ˆ ->
    //ì£¼ë¬¸ê±´ ì¡°ê±´ì´ ë§ì„ê²½ìš°, ì»¨íŠ¸ë™íŠ¸ì— ëˆ ì§€ë¶ˆ
    function payment()public payable {
        //ê³ ê° ì£¼ë¬¸ê±´ì´ ê°€ê²ŒëŠ”ìˆ˜ë½, ë¼ì´ë”ëŠ” ë°°ë‹¬í•˜ê¸°ë¡œ ì„ íƒí•œ ìƒíƒœ
        require(customers[msg.sender].goingOrder.storeStatus==storeState.accept &&
                customers[msg.sender].goingOrder.riderStatus==riderState.isPicked);
        //ì»¨íŠ¸ë™íŠ¸ì— ê°€ê²©ì§€ë¶ˆ
        require(
            msg.value==(customers[msg.sender].goingOrder.foodPrice+
            customers[msg.sender].goingOrder.deliveryFee+
            customers[msg.sender].goingOrder.deliveryTip)*1 ether
            );
            
       //ğŸš©ì•„ì§ transferê¸°ëŠ¥ ì‚¬ìš© ì•ˆí•˜ì‹ ê±°ì£ ??     
            
         
         //ğŸš©ì§„í–‰ ìƒí™©ì— ë”°ë¥¸ ê°ê°ì˜ enumê°’ ë³€ê²½(order í•˜ë‚˜ë¡œ í†µí•©ì‹œí‚¤ê³  í”„ë¡ íŠ¸ ê°ê°ì˜ í˜ì´ì§€ì—ì„œ orderê°’ ê°€ì§€ê³ ì™€ì„œ ì‚¬ìš©?)
        //ê°€ê²Œ(stores_owner)ì˜ orderìƒíƒœ ë³€ê²½
        stores_owner[customers[msg.sender].goingOrder.storeAddr].orderList[customers[msg.sender].goingOrder.orderID].storeStatus=storeState.checkMoney;
        
        //ë°°ë‹¬ì¡°íšŒ ëª©ë¡ ì£¼ë¬¸ê±´ì˜ ìƒíƒœë³€ê²½
        for(uint i=0;i<deliveryWaitingList.length;i++){
            if(deliveryWaitingList[i].customerAddr==msg.sender){
                deliveryWaitingList[i].storeStatus=storeState.checkMoney;     
            }
        }        
        //ê³ ê°ì˜ orderìƒíƒœ ë³€ê²½
        customers[msg.sender].goingOrder.storeStatus==storeState.checkMoney;
        
        //ë°°ë‹¬ì› ì£¼ë¬¸ê±´ì˜ ìƒíƒœ ë³€ê²½
        riders[customers[msg.sender].goingOrder.riderAddr].orders[customers[msg.sender].goingOrder.orderID].riderStatus = riderState.checkMoney;
/*
struct Basket {
        address customerAddr;
        address storeAddr;
        string customerAddress;
        string storeAddress;
        Menu[] menuNames;
        uint foodPrice;
        uint deliveryFee;
    }
*/
        // //ê³ ê°ì˜ basketì´ˆê¸°í™”
        // customers[msg.sender].basket.customerAddr=address(0);
        // customers[msg.sender].basket.storeAddr=address(0);
        // customers[msg.sender].basket.customerAddress="";
        // customers[msg.sender].basket.storeAddress="";
        // for(uint i=0;i<customers[msg.sender].basket.menuNames.length;i++){
        //     customers[msg.sender].basket.menuNames.pop();
        //     customers[msg.sender].basket.menuNames.pop();
        // }
        // customers[msg.sender].basket.foodPrice=0;
        // customers[msg.sender].basket.deliveryFee=0;
    }



    //ë¼ì´ë”---------------------------------------------------------------------------------------------
    /*
    function customerRegist(string memory _customerAddress) public {
        Customer storage newCustomer=customers[msg.sender];
        newCustomer.customerWallet=msg.sender;
        newCustomer.customerAddress=_customerAddress;

    }
    struct Rider {
        address  riderWallet;
        mapping(address=>Order) orders;
    }
    mapping(address => Rider) riders;
    */
    //ë¼ì´ë” ë“±ë¡ ê¸°ëŠ¥
    function riderRegist() public{       
        Rider storage newRider = riders[msg.sender];
        newRider.riderWallet = msg.sender;

    }

    

    //ë¼ì´ë”ì˜ ë°°ë‹¬ ì„ íƒ
    function riderPickOrder(uint _orderId)public {
        //ë¼ì´ë”ì˜ ë°°ë‹¬ëª©ë¡ì— ì¶”ê°€
        
        for(uint i=0;i<deliveryWaitingList.length;i++){
            if(deliveryWaitingList[i].orderID==_orderId){

                //ê³ ê° ì£¼ë¬¸ê±´ì— ë¼ì´ë” ë“±ë¡
                customers[deliveryWaitingList[i].customerAddr].goingOrder.riderAddr = msg.sender;
                //ê°€ê²Œ ì£¼ë¬¸ê±´ì— ë¼ì´ë” ë“±ë¡
                stores_owner[deliveryWaitingList[i].storeAddr].orderList[_orderId].riderAddr = msg.sender;
                //ë°°ë‹¬ë‹¬ ì£¼ë¬¸ê±´ì— ë¼ì´ë” ë“±ë¡
                deliveryWaitingList[i].riderAddr = msg.sender;

                // //ì£¼ë¬¸ê±´ì˜ ë°°ë‹¬ìƒíƒœ 'ì„ íƒ'
                // deliveryWaitingList[i].riderStatus=riderState.selected;
                // //ê³ ê°ì˜ orderìƒíƒœ ë³€ê²½
                // customers[deliveryWaitingList[i].customerAddr].goingOrder.riderStatus = riderState.selected;
                // //ê°€ê²Œ(stores_owner)ì˜ orderìƒíƒœ ë³€ê²½
                // stores_owner[deliveryWaitingList[i].storeAddr].orderList[_orderId].riderStatus= riderState.selected;
            }
        }
        //ì£¼ë¬¸ê±´ì˜ ë°°ë‹¬ìƒíƒœ 'ì„ íƒ'
        for(uint i=0;i<deliveryWaitingList.length;i++){
            if(deliveryWaitingList[i].riderAddr==msg.sender){
                Order storage newOrder = riders[msg.sender].orders[_orderId];
                newOrder.orderID= _orderId;
                newOrder.customerAddr=deliveryWaitingList[i].customerAddr;
                newOrder.storeAddr=deliveryWaitingList[i].storeAddr;
                newOrder.customerAddress=deliveryWaitingList[i].customerAddress;
                newOrder.storeAddress=deliveryWaitingList[i].storeAddress;
                for(uint j=0;j<customers[deliveryWaitingList[i].customerAddr].basket.menuNames.length;j++){
                    newOrder.menuName[customers[deliveryWaitingList[i].customerAddr].basket.menuNames[i].name]=customers[deliveryWaitingList[i].customerAddr].basket.menuNames[i];
                }
                newOrder.foodPrice=deliveryWaitingList[i].foodPrice;
                newOrder.deliveryFee=deliveryWaitingList[i].deliveryFee;
                newOrder.deliveryTip=deliveryWaitingList[i].deliveryTip;
                newOrder.storeStatus=deliveryWaitingList[i].storeStatus;
                newOrder.riderStatus=deliveryWaitingList[i].riderStatus;
                //ë°°ë‹¬ ëŒ€ê¸°ëª©ë¡ì˜ ì£¼ë¬¸ê±´ ìƒíƒœ ìˆ˜ì •
                
                deliveryWaitingList[i].riderStatus=riderState.isPicked;
                
                //ê³ ê°ì˜ ì£¼ë¬¸ê±´ ìƒíƒœ ìˆ˜ì •
                //customers[deliveryWaitingList[i].customerAddr].goingOrder.storeStatus=storeState.isPicked;
                customers[deliveryWaitingList[i].customerAddr].goingOrder.riderStatus=riderState.isPicked;
                //ê°€ê²Œì˜ ì£¼ë¬¸ê±´ ìƒíƒœ ìˆ˜ì •
                //stores_owner[deliveryWaitingList[i].storeAddr].orderList[_orderId].storeStatus=storeState.isPicked;
                stores_owner[deliveryWaitingList[i].storeAddr].orderList[_orderId].riderStatus=riderState.isPicked;
                  
            }
        } 
    }

    //ë°°ë‹¬ ì‹œì‘ ê¸°ëŠ¥
    function riderStartDelivery(uint _orderId)public {
        //ëˆ ë°›ì•„ì•¼ ë°°ë‹¬ ì¶œë°œì¡°ê±´ê±´
        require(riders[msg.sender].orders[_orderId].riderStatus==riderState.checkMoney);
        //ë°°ë‹¬ ìƒíƒœ ì§„í–‰ì¤‘ìœ¼ë¡œë¡œ
        riders[msg.sender].orders[_orderId].riderStatus=riderState.inDelivery;
        //ë°°ë‹¬ ëŒ€ê¸°ëª©ë¡ì˜ ë°°ë‹¬ ìƒíƒœ ì§„í–‰ì¤‘ìœ¼ë¡œë¡œ
        for(uint i=0;i<deliveryWaitingList.length;i++){
            if(deliveryWaitingList[i].orderID==_orderId){
                deliveryWaitingList[i].riderStatus=riderState.inDelivery;
            }
        }
        
    }
    //ë°°ë‹¬ ì™„ë£Œ ê¸°ëŠ¥
    function riderFinishDelivery(uint _orderId)public {
        require(riders[msg.sender].orders[_orderId].riderStatus==riderState.inDelivery);
        riders[msg.sender].orders[_orderId].riderStatus=riderState.deliveryComplete;

        //ë°°ë‹¬ ëŒ€ê¸°ëª©ë¡ì˜ ë°°ë‹¬ ìƒíƒœ ì™„ë£Œë¡œ
        for(uint i=0;i<deliveryWaitingList.length;i++){
            if(deliveryWaitingList[i].orderID==_orderId){
                deliveryWaitingList[i].riderStatus=riderState.deliveryComplete;
            }
        }
        //ê³ ê°ì˜ ë°°ë‹¬ ê³¼ê±°ëª©ë¡ì— ì¶”ê°€
        
        Order storage pastOrder = customers[riders[msg.sender].orders[_orderId].customerAddr].pastOrderList[_orderId];
        
        pastOrder.orderID= customers[riders[msg.sender].orders[_orderId].customerAddr].goingOrder.orderID;
        pastOrder.customerAddr=customers[riders[msg.sender].orders[_orderId].customerAddr].goingOrder.customerAddr;
        pastOrder.storeAddr=customers[riders[msg.sender].orders[_orderId].customerAddr].goingOrder.storeAddr;
        pastOrder.customerAddress=customers[riders[msg.sender].orders[_orderId].customerAddr].goingOrder.customerAddress;
        pastOrder.storeAddress=customers[riders[msg.sender].orders[_orderId].customerAddr].goingOrder.storeAddress;
        for(uint i=0;i<customers[riders[msg.sender].orders[_orderId].customerAddr].basket.menuNames.length;i++){
            pastOrder.menuName[customers[riders[msg.sender].orders[_orderId].customerAddr].basket.menuNames[i].name]=customers[riders[msg.sender].orders[_orderId].customerAddr].basket.menuNames[i];
        }
        
        pastOrder.foodPrice=customers[riders[msg.sender].orders[_orderId].customerAddr].goingOrder.foodPrice;
        pastOrder.deliveryFee=customers[riders[msg.sender].orders[_orderId].customerAddr].goingOrder.deliveryFee;
        pastOrder.deliveryTip=customers[riders[msg.sender].orders[_orderId].customerAddr].goingOrder.deliveryTip;
        pastOrder.storeStatus=customers[riders[msg.sender].orders[_orderId].customerAddr].goingOrder.storeStatus;
        pastOrder.riderStatus=customers[riders[msg.sender].orders[_orderId].customerAddr].goingOrder.riderStatus; 
        
        //ê³ ê°ì˜ goingOrderì´ˆê¸°í™”
        

        customers[msg.sender].goingOrder.orderID= 0;
        customers[msg.sender].goingOrder.customerAddr=address(0);
        customers[msg.sender].goingOrder.storeAddr=address(0);
        customers[msg.sender].goingOrder.customerAddress="";
        customers[msg.sender].goingOrder.storeAddress="";
        for(uint i=0;i<customers[riders[msg.sender].orders[_orderId].customerAddr].basket.menuNames.length;i++){
            delete customers[msg.sender].goingOrder.menuName[customers[riders[msg.sender].orders[_orderId].customerAddr].basket.menuNames[0].name];
        }        
        customers[msg.sender].goingOrder.foodPrice=0;
        customers[msg.sender].goingOrder.deliveryFee=0;
        customers[msg.sender].goingOrder.deliveryTip=0;
        customers[msg.sender].goingOrder.storeStatus=storeState.notyetChoice;
        customers[msg.sender].goingOrder.riderStatus=riderState.notSelected; 
        

        //ê³ ê°ì˜ basketì´ˆê¸°í™”
        customers[riders[msg.sender].orders[_orderId].customerAddr].basket.customerAddr=address(0);
        customers[riders[msg.sender].orders[_orderId].customerAddr].basket.storeAddr=address(0);
        customers[riders[msg.sender].orders[_orderId].customerAddr].basket.customerAddress="";
        customers[riders[msg.sender].orders[_orderId].customerAddr].basket.storeAddress="";
        for(uint i=0;i<customers[riders[msg.sender].orders[_orderId].customerAddr].basket.menuNames.length;i++){
            customers[riders[msg.sender].orders[_orderId].customerAddr].basket.menuNames.pop();
        }
        customers[riders[msg.sender].orders[_orderId].customerAddr].basket.foodPrice=0;
        customers[riders[msg.sender].orders[_orderId].customerAddr].basket.deliveryFee=0;

    }

    // function getRiderMyOrder(uint _orderId)public view returns(address){
    //         return riders[msg.sender].orders[_orderId].customerAddr;
    //     }   
    /*
    function getStoreState()public view returns(storeState){
        return customers[msg.sender].goingOrder.storeStatus;
    }
    function getRiderState()public view returns(riderState){
        return customers[msg.sender].goingOrder.riderStatus;
    }
    function getFoodPrice()public view returns(uint){
        return customers[msg.sender].goingOrder.foodPrice;
    }
    function getDeliveryFee()public view returns(uint){
        return customers[msg.sender].goingOrder.deliveryFee;
    }
    function getDeliveryTip()public view returns(uint){
        return customers[msg.sender].goingOrder.deliveryTip;
    }
    */

    //ê´€ë¦¬ì---------------------------------------------------------------------------------------------

    function withdraw(uint _amount)public {
        require(msg.sender == owner);
        payable (msg.sender).transfer(_amount * 1 ether);
    }

}
